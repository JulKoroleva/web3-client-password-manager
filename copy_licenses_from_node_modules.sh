#!/bin/bash

if [ $# -ne 2 ]; then
    echo "Usage: $0 <path_to_license_info_file> <destination_directory>"
    exit 1
fi

license_info_file=$1
destination_directory=$2

if [ ! -f "$license_info_file" ]; then
    echo "Error: License info file '$license_info_file' not found"
    exit 1
fi

if [ ! -d "$destination_directory" ]; then
    echo "Error: Destination directory '$destination_directory' not found"
    exit 1
fi

packages=$(jq 'keys[]' "$license_info_file")
for package in $packages; do
    license_file=$(jq -r ".$package.licenseFile" "$license_info_file")
    licenses=$(jq -r ".$package.licenses" "$license_info_file")

    if [ "$license_file" = "null" ]; then
        echo "Warning: License file for package '$package' is not specified"
        touch "$destination_directory/LICENSE__${licenses}__${package//[^[:alnum:]]/}"
        continue
    fi

    license_file_basename=$(basename "$license_file")

    if [ "$licenses" = "null" ]; then
        echo "Warning: License type for package '$package' is not specified"
        licenses="unknown"
    fi

    new_license_filename="LICENSE__${licenses}__${package//[^[:alnum:]_[:space:]]/_}"
    string=${new_license_filename}
    clean_string=$(echo "$string" | tr -cd '[:alnum:]_[:space:]' | tr ' ' '_' )
    clean_string=$(echo "$clean_string" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
    trimmed_string="${clean_string%?}"
    new_license_filename_clean=${trimmed_string}

    cp "$license_file" "$destination_directory/$new_license_filename_clean"
done

echo "License files copied to $destination_directory"